name: Block generated trajectory files in PRs

on:
    pull_request:
        types: [opened, synchronize, reopened]
    push:
        branches:
            - "**"

jobs:
    check-generated-files:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Detect changes in generated files (pull_request)
              if: github.event_name == 'pull_request'
              run: |
                  git fetch origin ${{ github.event.pull_request.base.ref }}:refs/remotes/origin/${{ github.event.pull_request.base.ref }}
                  CHANGED=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep -E '^public/(trajectory.json|simulation_log.csv)$' || true)
                  if [ -n "$CHANGED" ]; then
                    echo "::error::Found changes to generated files: $CHANGED"
                    echo "Do not commit public/trajectory.json or public/simulation_log.csv. Run 'pnpm export-trajectory' locally and remove them from the commit (git rm --cached <file>) before pushing. CI will generate them in GitHub Actions."
                    exit 1
                  fi

            - name: Detect changes in generated files (push)
              if: github.event_name == 'push'
              run: |
                  BRANCH=${GITHUB_REF#refs/heads/}
                  # list files changed in the push range
                  CHANGED=$(git diff --name-only origin/$BRANCH^..HEAD | grep -E '^public/(trajectory.json|simulation_log.csv)$' || true)
                  if [ -n "$CHANGED" ]; then
                    echo "::error::Found changes to generated files: $CHANGED"
                    echo "Do not commit public/trajectory.json or public/simulation_log.csv. Run 'pnpm export-trajectory' locally and remove them from the commit (git rm --cached <file>) before pushing. CI will generate them in GitHub Actions."
                    exit 1
                  fi
